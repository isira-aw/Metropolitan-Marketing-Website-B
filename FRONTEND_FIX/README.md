# üéØ Production-Ready Authentication Flow - Complete Fix

## üìä REQUEST FLOW DIAGRAM

```
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ 1. USER ACTION (Component)                                              ‚îÇ
‚îÇ    - User clicks "Load Employees"                                        ‚îÇ
‚îÇ    - Component calls: employeeApi.getAll()                              ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
                         ‚îÇ
                         ‚ñº
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ 2. API SERVICE LAYER (lib/api.ts)                                       ‚îÇ
‚îÇ    - employeeApi.getAll() ‚Üí axiosInstance.get('/api/admin/employees')   ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
                         ‚îÇ
                         ‚ñº
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ 3. AXIOS REQUEST INTERCEPTOR (lib/axios.ts)                             ‚îÇ
‚îÇ    - Reads token from localStorage: const token = localStorage.getItem  ‚îÇ
‚îÇ    - Adds header: Authorization: Bearer {token}                          ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
                         ‚îÇ
                         ‚ñº
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ 4. BROWSER (Network Layer)                                              ‚îÇ
‚îÇ                                                                           ‚îÇ
‚îÇ    Step 4a: OPTIONS Preflight Request                                   ‚îÇ
‚îÇ    ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ                     ‚îÇ
‚îÇ    OPTIONS http://localhost:8080/api/admin/employees                    ‚îÇ
‚îÇ    Origin: http://localhost:3001                                         ‚îÇ
‚îÇ    Access-Control-Request-Method: GET                                    ‚îÇ
‚îÇ    Access-Control-Request-Headers: authorization,content-type           ‚îÇ
‚îÇ                                                                           ‚îÇ
‚îÇ    Step 4b: Spring Boot CORS Response                                   ‚îÇ
‚îÇ    ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ                               ‚îÇ
‚îÇ    200 OK                                                                ‚îÇ
‚îÇ    Access-Control-Allow-Origin: http://localhost:3001                   ‚îÇ
‚îÇ    Access-Control-Allow-Methods: GET, POST, PUT, DELETE, OPTIONS        ‚îÇ
‚îÇ    Access-Control-Allow-Headers: *                                       ‚îÇ
‚îÇ    Access-Control-Allow-Credentials: true                                ‚îÇ
‚îÇ                                                                           ‚îÇ
‚îÇ    Step 4c: Actual GET Request                                           ‚îÇ
‚îÇ    ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ                                        ‚îÇ
‚îÇ    GET http://localhost:8080/api/admin/employees                        ‚îÇ
‚îÇ    Authorization: Bearer eyJhbGciOiJIUzI1NiJ9...                         ‚îÇ
‚îÇ    Content-Type: application/json                                        ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
                         ‚îÇ
                         ‚ñº
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ 5. SPRING BOOT BACKEND                                                   ‚îÇ
‚îÇ                                                                           ‚îÇ
‚îÇ    Step 5a: JwtAuthenticationFilter (line 28)                           ‚îÇ
‚îÇ    ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ                         ‚îÇ
‚îÇ    - Extracts: Authorization: Bearer {token}                             ‚îÇ
‚îÇ    - Validates JWT signature and expiration                              ‚îÇ
‚îÇ    - Loads UserDetails from database                                     ‚îÇ
‚îÇ    - Sets SecurityContext authentication                                 ‚îÇ
‚îÇ                                                                           ‚îÇ
‚îÇ    Step 5b: Security Filter Chain (SecurityConfig line 42)              ‚îÇ
‚îÇ    ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ              ‚îÇ
‚îÇ    - Checks: /api/admin/** requires authenticated()                      ‚îÇ
‚îÇ    - If authenticated ‚Üí proceed to controller                            ‚îÇ
‚îÇ    - If NOT authenticated ‚Üí return 403 Forbidden                         ‚îÇ
‚îÇ                                                                           ‚îÇ
‚îÇ    Step 5c: Controller (if authenticated)                                ‚îÇ
‚îÇ    ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ                            ‚îÇ
‚îÇ    - Fetches employees from database                                     ‚îÇ
‚îÇ    - Returns: 200 OK with JSON data                                      ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
                         ‚îÇ
                         ‚ñº
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ 6. AXIOS RESPONSE INTERCEPTOR (lib/axios.ts)                            ‚îÇ
‚îÇ                                                                           ‚îÇ
‚îÇ    SUCCESS (200-299):                                                    ‚îÇ
‚îÇ    - Returns response.data to caller                                     ‚îÇ
‚îÇ    - Component receives: Employee[]                                      ‚îÇ
‚îÇ                                                                           ‚îÇ
‚îÇ    ERROR (401/403):                                                      ‚îÇ
‚îÇ    - Logs error for debugging                                            ‚îÇ
‚îÇ    - Dispatches: window.dispatchEvent('auth:unauthorized')               ‚îÇ
‚îÇ    - Returns Promise.reject(error) to caller                             ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
                         ‚îÇ
                         ‚ñº
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ 7. ERROR HANDLING                                                        ‚îÇ
‚îÇ                                                                           ‚îÇ
‚îÇ    AuthContext (listens for 'auth:unauthorized' event):                 ‚îÇ
‚îÇ    - Calls logout()                                                      ‚îÇ
‚îÇ    - Clears localStorage                                                 ‚îÇ
‚îÇ    - Sets admin = null                                                   ‚îÇ
‚îÇ                                                                           ‚îÇ
‚îÇ    Component (receives rejected promise):                                ‚îÇ
‚îÇ    - Catches error in try/catch                                          ‚îÇ
‚îÇ    - Shows error message to user                                         ‚îÇ
‚îÇ    - Redirects to /admin/login                                           ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
```

---

## üåê EXPECTED BROWSER NETWORK TAB BEHAVIOR

### ‚úÖ CORRECT (After Fix)

When you load `/admin/employees` page:

```
1. OPTIONS /api/admin/employees     [Preflight]
   Status: 200 OK
   Time: ~10ms

2. GET /api/admin/employees         [Actual Request]
   Status: 200 OK
   Request Headers:
     Authorization: Bearer eyJhbGci...
     Content-Type: application/json
   Response: [{"id": 1, "name": "John"}, ...]
   Time: ~50ms
```

**Total: 2 requests (1 OPTIONS + 1 GET)**

### ‚ùå BROKEN (Before Fix)

```
1. OPTIONS /api/admin/employees
2. GET /api/admin/employees         ‚Üí 403 Forbidden
3. OPTIONS /api/admin/employees     [Retry caused by interceptor]
4. GET /api/admin/employees         ‚Üí 403 Forbidden
5. OPTIONS /api/admin/employees     [Loop continues...]
6. GET /api/admin/employees         ‚Üí 403 Forbidden
... repeats 10+ times
```

**Total: 20+ requests (infinite loop until timeout)**

---

## üîÑ WHY PREFLIGHTS HAPPEN (AND WHY IT'S NORMAL)

### CORS Preflight is Triggered By:

1. **Custom Headers** (like `Authorization: Bearer`)
2. **Methods** other than GET/POST/HEAD
3. **Content-Type** other than application/x-www-form-urlencoded, multipart/form-data, text/plain

### Your Backend Correctly Handles Preflights:

```java
// CorsConfig.java line 22
configuration.setAllowedMethods(Arrays.asList("GET", "POST", "PUT", "DELETE", "OPTIONS"));
configuration.setAllowedHeaders(Arrays.asList("*"));
configuration.setAllowCredentials(true);
```

**This is CORRECT. Do NOT try to "disable" preflights.**

### How to Minimize Preflights:

‚úÖ **DO:**
- Accept that every protected request will have OPTIONS + actual request
- Optimize preflight cache with `Access-Control-Max-Age` (already default)
- Make sure OPTIONS requests are fast (~10ms)

‚ùå **DON'T:**
- Try to remove `Authorization` header (breaks auth)
- Try to disable CORS (breaks frontend)
- Retry on preflight failures (causes loops)

---

## üö® COMMON BUGS & FIXES

### Bug #1: Repeated API Calls

**BROKEN CODE:**
```typescript
useEffect(() => {
  fetchEmployees();
}, [isAuthenticated]); // ‚ùå Runs every time auth state changes
```

**FIXED CODE:**
```typescript
useEffect(() => {
  if (!isAuthenticated) return;
  fetchEmployees();
}, []); // ‚úÖ Runs once on mount
```

---

### Bug #2: Infinite Redirect Loop

**BROKEN CODE:**
```typescript
// In axios response interceptor
if (error.response?.status === 403) {
  window.location.href = '/login'; // ‚ùå Hard redirect in interceptor
}
```

**FIXED CODE:**
```typescript
// In axios response interceptor
if (status === 401 || status === 403) {
  window.dispatchEvent(new CustomEvent('auth:unauthorized')); // ‚úÖ Event-based
}

// In AuthContext
useEffect(() => {
  window.addEventListener('auth:unauthorized', logout);
}, []);
```

---

### Bug #3: Raw Axios Usage

**BROKEN CODE:**
```typescript
import axios from 'axios'; // ‚ùå Not the configured instance

const res = await axios.get('http://localhost:8080/api/admin/employees');
// No token, no interceptor ‚Üí 403
```

**FIXED CODE:**
```typescript
import { employeeApi } from '@/lib/api'; // ‚úÖ Use centralized API

const res = await employeeApi.getAll();
// Token added automatically by interceptor
```

---

### Bug #4: Stale Token

**BROKEN CODE:**
```typescript
const token = useState(localStorage.getItem('token')); // ‚ùå Only read once

axiosInstance.interceptors.request.use((config) => {
  config.headers.Authorization = `Bearer ${token}`; // Stale token!
});
```

**FIXED CODE:**
```typescript
axiosInstance.interceptors.request.use((config) => {
  const token = localStorage.getItem('token'); // ‚úÖ Read fresh every time
  config.headers.Authorization = `Bearer ${token}`;
});
```

---

## üìã MIGRATION CHECKLIST

### Step 1: Replace Axios Configuration

- [ ] Delete all existing axios instances/configurations
- [ ] Copy `lib/axios.ts` to your project
- [ ] Update `baseURL` in axios.ts to your API URL

### Step 2: Replace AuthContext

- [ ] Delete existing AuthContext/AuthProvider
- [ ] Copy `contexts/AuthContext.tsx` to your project
- [ ] Wrap your app with `<AuthProvider>` in root layout

### Step 3: Create API Service Layer

- [ ] Copy `lib/api.ts` to your project
- [ ] Add/remove API functions based on your backend endpoints
- [ ] Update TypeScript types to match your DTOs

### Step 4: Update Components

- [ ] Find all `import axios from 'axios'` ‚Üí Replace with `import api from '@/lib/api'`
- [ ] Find all `useEffect` with auth dependencies ‚Üí Remove auth from deps
- [ ] Find all manual token handling ‚Üí Remove (handled by interceptor)
- [ ] Use the example `page.tsx` pattern for all data-fetching pages

### Step 5: Test

- [ ] Login works ‚Üí Token stored in localStorage
- [ ] Navigate to protected page ‚Üí Single OPTIONS + Single GET request
- [ ] Logout works ‚Üí Token cleared, redirected to login
- [ ] Expired token ‚Üí Auto-logout and redirect
- [ ] Network tab shows clean request pattern (no loops)

---

## üéì ARCHITECTURE PRINCIPLES

### Separation of Concerns

```
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ BACKEND (Spring Boot)                                    ‚îÇ
‚îÇ - Business logic                                         ‚îÇ
‚îÇ - Data validation                                        ‚îÇ
‚îÇ - JWT generation & validation                            ‚îÇ
‚îÇ - Database operations                                    ‚îÇ
‚îÇ - Security rules                                         ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò

‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ FRONTEND (Next.js)                                       ‚îÇ
‚îÇ - UI rendering                                           ‚îÇ
‚îÇ - User interactions                                      ‚îÇ
‚îÇ - State management (UI state only)                       ‚îÇ
‚îÇ - Token storage (localStorage)                           ‚îÇ
‚îÇ - Error display                                          ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
```

### Single Responsibility

- **axios.ts**: HTTP client configuration only
- **AuthContext.tsx**: Auth state management only
- **api.ts**: API endpoint definitions only
- **Components**: UI rendering and user interactions only

### No Cross-Cutting Concerns

‚ùå **DON'T** put redirects in interceptors
‚ùå **DON'T** put data fetching in auth context
‚ùå **DON'T** put auth logic in components
‚úÖ **DO** use event-based communication between layers

---

## üêõ DEBUGGING GUIDE

### If API calls are still repeated:

1. **Check React Strict Mode:**
   ```typescript
   // next.config.js
   reactStrictMode: true // Components mount twice in dev mode
   ```
   **Solution:** Use `useRef` flag to prevent double fetch (see example)

2. **Check useEffect dependencies:**
   ```typescript
   useEffect(() => {
     // Should be empty or non-auth values
   }, []); // ‚Üê Check this array
   ```

3. **Check for multiple axios instances:**
   ```bash
   # Search your codebase
   grep -r "axios.create" src/
   grep -r "import axios from" src/
   ```
   **Solution:** Only use `axiosInstance` from `lib/axios.ts`

### If 403 errors persist:

1. **Check token in browser:**
   ```javascript
   // In browser console
   localStorage.getItem('token')
   ```

2. **Decode JWT:**
   - Copy token
   - Visit https://jwt.io
   - Check expiration (`exp` field)

3. **Check backend logs:**
   ```bash
   # Look for JWT validation errors
   grep "Error extracting username" backend.log
   ```

4. **Check Network tab:**
   - Request Headers ‚Üí Should have `Authorization: Bearer ...`
   - Response ‚Üí Should be 200 OK, not 403

---

## ‚úÖ SUCCESS CRITERIA

Your fix is complete when:

- [ ] Login ‚Üí Dashboard: **2 requests** (1 OPTIONS + 1 GET)
- [ ] Refresh page: **2 requests** (not 20+)
- [ ] Logout ‚Üí Login: No errors in console
- [ ] Expired token ‚Üí Auto-logout and clean redirect
- [ ] All protected endpoints work with same pattern
- [ ] Network tab shows clean pattern:
  ```
  OPTIONS ‚Üí 200
  GET ‚Üí 200
  (repeat for each unique endpoint, but NO loops)
  ```

---

## üìû TROUBLESHOOTING

If you still see issues after implementing this fix:

1. **Clear browser cache and localStorage**
2. **Restart Spring Boot backend**
3. **Hard refresh frontend (Cmd+Shift+R / Ctrl+Shift+R)**
4. **Check BOTH browser console AND backend logs**
5. **Compare your code line-by-line with the examples**

---

## üéâ FINAL NOTES

This architecture is:
- ‚úÖ Production-ready
- ‚úÖ Type-safe (TypeScript)
- ‚úÖ Scalable (add new endpoints easily)
- ‚úÖ Debuggable (clear separation of concerns)
- ‚úÖ Maintainable (single source of truth)
- ‚úÖ Performant (no unnecessary requests)

**The `/employees` endpoint worked by accident, probably using the configured axios instance. Other endpoints failed because they used raw axios or had retry logic. This fix ensures ALL endpoints work the same way.**
